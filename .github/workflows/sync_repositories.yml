name: Sync Directory Changes to Multiple Repositories

on:
  push:
    paths:
      - '.github/**'

jobs:
  Sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4.1.6

      - name: Get changed files
        id: get-changed-files
        run: |
          git diff --name-only HEAD~1 HEAD | grep -E '^((?!\.git|public).)*$' > changed_files.txt

      - name: Create pull requests for each changed file
        id: create-pull-requests
        env:
          GITHUB_REPOSITORY: 'pia-corp'
          repo_name: 'template'
          GITHUB_ACTOR: 'github-actions[bot]'
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          while IFS= read -r line; do
            filename="$line"
            repo_name="repo-name-$line" # ダウンストリームリポジトリ名のプレフィックス
            git clone https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY/$repo_name.git
            cd $repo_name
            git checkout main
            git pull
            cp "$filename" .
            git add .
            git commit -m "Auto-merge: $filename"
            git push
          done < changed_files.txt

      - name: Cleanup
        run: |
          rm changed_files.txt
