name: CI

on:
  pull_request:
    branches:
      - main
    types: [opened, edited, reopened, synchronize]

jobs:
  Markup_Linter:
    name: Markup Linter
    if: github.event.sender.type != 'Bot' && contains(github.head_ref, 'develop')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Test name
        id: opening_announce
        run: |
          echo "${{ github.event.sender.type }}"
          echo "${{ github.head_ref || github.ref_name }}"
          echo ${{ github.ref }}

      - name: Checkout the repository
        uses: actions/checkout@v4.1.4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4.0.2
        with:
          node-version: "${{ vars.GIT_ACTIONS_NODE_VER }}"
          cache: npm

      - name: Restore npm dependencies
        id: cache_dependency
        uses: actions/cache@v4.0.2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Install npm dependencies (if cache miss)
        if: steps.restore_node_modules.outputs.cache-hit != 'true'
        run: npm ci --no-audit --progress=false --silent

      - name: Lint and rewrite markup
        if: startsWith(github.ref, 'pre')
        run: npm run linter

  Markup_Linter_no_need:
    name: Markup Linter(no need)
    if: contains(github.head_ref, 'release')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Skip
        run: echo "skip"

  Lighthouse:
    name: Lighthouse
    if: contains(github.head_ref, 'develop')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Test name
        id: opening_announce
        run: |
          echo "${{ github.event.sender.type }}"
          echo "${{ github.actor }}"
          echo "${{ github.head_ref || github.ref_name }}"

      - name: Check out repository
        uses: actions/checkout@v4.1.4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4.0.2
        with:
          node-version: "${{ vars.GIT_ACTIONS_NODE_VER }}"

      - name: Restore npm dependencies
        uses: actions/cache@v4.0.2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-node_modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node_modules-

      - name: Install npm dependencies (if cache miss)
        if: steps.restore_node_modules.outputs.cache-hit != 'true'
        run: npm ci --no-audit --progress=false --silent

      # - name: Run Lighthouse against a static dist dir
      #   id: lighthouse_audit
      #   uses: treosh/lighthouse-ci-action@v11
      #   with:
      #     configPath: './.github/config/.lighthouserc.json'
      #     temporaryPublicStorage: true
      #   continue-on-error: true

      # - name: Comment on PR with Lighthouse results
      #   id: format_lighthouse_score
      #   uses: actions/github-script@v7.0.1
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       const urls = ${{steps.lighthouse_audit.outputs.links}};
      #       const assertion = ${{steps.lighthouse_audit.outputs.assertionResults}};
      #       const obj = ${{ steps.lighthouse_audit.outputs.manifest }};
      #       const formatResult = (res) => Math.round((res * 100));
      #       const file_name = (url) => { return url.replace(/^http:\/\/localhost:\d+\//, ""); };
      #       const score = res => res >= 90 ? 'ğŸŸ¢' : res >= 50 ? 'ğŸŸ ' : 'ğŸ”´';
      #       const getValueByKey = (key) => { return urls[key] || null };
      #       let exists_error = 0;

      #       let view_text2 = "";
      #       const assertion_body = (value) => {
      #         if (value.passed == false) {
      #           const passed = value.passed;
      #           const auditProperty = value.auditProperty;
      #           view_text2 += `âŒ${file_name(value.url)}ã®${auditProperty}ãŒé–¾å€¤ã«é”ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
      #           `;
      #         }
      #         if (!exists_error) {
      #           if (value.passed == false) {
      #             exists_error = 1;
      #           }
      #         }
      #       ;}
      #       Object.keys(assertion).forEach(key => assertion[key] = assertion_body(assertion[key]));

      #       let view_text = "";
      #       const table_body = (urlArray) => {
      #         if (urlArray.isRepresentativeRun == true) {
      #           const accessibility = formatResult(urlArray.summary["accessibility"]);
      #           const practices = formatResult(urlArray.summary["best-practices"]);
      #           const performance = formatResult(urlArray.summary["performance"]);
      #           const seo = formatResult(urlArray.summary["seo"]);
      #           view_text += `| [${file_name(urlArray.url)}](${getValueByKey(urlArray.url)}) | ${score(performance)} ${performance} | ${score(accessibility)} ${accessibility} | ${score(practices)} ${practices} | ${score(seo)} ${seo} |\n`;
      #         }
      #       };
      #       Object.keys(obj).forEach(key => obj[key] = table_body(obj[key]));

      #       let param = {
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: `âš¡ï¸ [Lighthouse Mobile Report]:

      #       | File name | Performance | Accessibility | Best practices | SEO |
      #       | --- | --- | --- | --- | --- |
      #       ${view_text}

      #       â€»è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹çµæœã¯3å›ã®çµæœã‹ã‚‰å¾—ã‚‰ã‚ŒãŸä¸­å¤®å€¤ã§ã™ã€‚
      #       â€»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµæœã¯ãƒ–ãƒ¬ãŒã‚ã‚Šã¾ã™ãƒªãƒ³ã‚¯å…ˆã®è¨ºæ–­çµæœã‚’è¦‹ã¦åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚`};

      #       core.setOutput("exists_error", exists_error);
      #       core.setOutput("error_message", view_text2);
      #       await github.rest.issues.createComment(param);

      # - name: Comment on PR with warnings
      #   if: ${{ steps.format_lighthouse_score.outputs.exists_error == '1' }}
      #   uses: actions/github-script@v7.0.1
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       const error_message = `${{ steps.format_lighthouse_score.outputs.error_message }}`;
      #       let param = {
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: error_message
      #       };
      #       await github.rest.issues.createComment(param);

      - name: Fail workflow if there are errors
        if: ${{ steps.format_lighthouse_score.outputs.exists_error == '1' }}
        run: exit 1

  Lighthouse_no_need:
    name: Lighthouse(no need)
    if: contains(github.head_ref, 'release')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Skip
        run: echo "skip"
