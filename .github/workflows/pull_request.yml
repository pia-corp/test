name: Pull Request

on:
  pull_request:
    branches:
      - main
    types:
      - opened

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      public_changed: ${{ steps.detect_changes.outputs.public_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.6

      - name: Detect changes in the public folder
        id: detect_changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q '^public/'; then
            echo "public_changed=true" >> $GITHUB_ENV
          else
            echo "public_changed=false" >> $GITHUB_ENV
          fi

  SETUP:
    if: github.event.sender.type != 'Bot' && contains(github.head_ref, 'develop') && needs.check_changes.outputs.public_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4.1.6

      - name: Setup Node.js
        uses: actions/setup-node@v4.0.2
        with:
          node-version: "${{ vars.GIT_ACTIONS_NODE_VER }}"
          cache: npm

      - name: Restore npm dependencies
        id: cache-npm
        uses: actions/cache@v4.0.2
        env:
          cache-name: cache-node-modules
        with:
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-v${{ vars.GIT_ACTIONS_NODE_VER }}-${{ hashFiles('**/package-lock.json') }}

      - name: Install npm dependencies (if cache miss)
        if: ${{ steps.cache-npm.outputs.cache-hit != 'true' }}
        run: npm ci --no-audit --progress=false --silent

  OPENING_ANNOUNCE:
    needs: SETUP
    runs-on: ubuntu-latest
    timeout-minutes: 2

    permissions:
      pull-requests: write

    steps:
      - name: Set up opening announce
        id: opening_announce
        run: |
          lf='\n'
          message="@${{ github.event.pull_request.user.login }} ã•ã‚“ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼ :tada:"
          message+="${lf}${lf}ã‚³ãƒ¼ãƒ‰æ¤œåŽã¯ä¸‹è¨˜ã®æ‰‹é †ã§è¡Œã£ã¦ãã ã•ã„ã€‚"
          message+="${lf}ã‚³ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒŠãƒ¼ã¯æ‰¿èªå‰ã«ãƒã‚§ãƒƒã‚¯ã‚’é€šéŽã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          message+="${lf}    - \`linter\`ã«åˆæ ¼ã—ãªã‹ã£ãŸå ´åˆã¯ã€åŽŸå› ã‚’ç‰¹å®šã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
          message+="${lf}    - HTMLã®Markupãƒ«ãƒ¼ãƒ«ã¯[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](../blob/main/doc/markup_rule.md)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          message+="${lf}    - Lighthouseã¯1ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯ã«30ç§’ã€œ60ç§’ã‹ã‹ã‚Šã¾ã™ã€‚å¯èƒ½ãªé™ã‚Šãƒ­ãƒ¼ã‚«ãƒ«ã§æ¤œè¨¼ã—ã¦ã‹ã‚‰ãƒ—ãƒ«ãƒªã‚¯ã‚’å‡ºã—ã¦ãã ã•ã„ã€‚"
          message+="${lf}    - ðŸ”´ï¼š**ä¿®æ­£å¿…é ˆ**ã€ðŸŸ ï¼š**å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£**ã€ðŸŸ¢ï¼š**å•é¡Œãªã—** ã§ã™ã€‚"
          message+="${lf}    - ã‚³ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒŠãƒ¼ã‹ã‚‰\`approve\`ã•ã‚ŒãŸå¾Œã«ã€\`main\`ãƒ–ãƒ©ãƒ³ãƒã«ãƒžãƒ¼ã‚¸ã—ã¾ã™ã€‚"
          echo "message=${message}" >> $GITHUB_OUTPUT

      - name: Comment opening announce
        uses: actions/github-script@v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const params = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: '${{ steps.opening_announce.outputs.message }}'
            }
            await github.rest.issues.createComment(params)
